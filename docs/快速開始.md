# å¿«é€Ÿé–‹å§‹

## Django Shell
API server ç›®å‰æœ‰çš„å¥—ä»¶éƒ½æœƒåœ¨é€™å€‹shellä¸­ï¼Œå¯ä»¥åœ¨æ­¤äº¤äº’æ¨¡å¼ä¸­æ¸¬è©¦

é€²å…¥å®¹å™¨
```
$ docker-compose exec web bash
```

å•Ÿå‹•django shell
```
root@b6dfc43556c6:/app# python manage.py shell

Python 3.11.11 (main, Feb  4 2025, 13:44:55) [GCC 12.2.0] on linux
Type "help", "copyright", "credits" or "license" for more information.
(InteractiveConsole)
>>> 
```

## REST api serviceé–‹ç™¼
### 1. ä½¿ç”¨Djangoçš„å‘½ä»¤ç‚ºè‡ªå·±å‰µå»ºéœ€è¦çš„app
```
python manage.py startapp <app-name>
```

å°‡ç”¢ç”Ÿçš„python packageç§»å‹•åˆ°appsä¸­ï¼Œè¨˜å¾—è¦ä¿®æ”¹`apps.py`ï¼Œè£¡é¢æœƒæœ‰ä¸€å€‹çˆ¶é¡ç‚º`AppConfig`çš„class
è«‹å°‡nameå±¬æ€§å¢åŠ å‰ç¶´appsï¼Œ

e.g. `python manage.py startapp articles`

è«‹ä¿®æ”¹ç‚º `name = 'apps.articles'`

æ–¼`settings.py`ä¸­è¨»å†Šæ­¤app

```python
LOCAL_APPS = [
    'apps.users',
    'apps.orders',
    'apps.polls',
    'apps.health',
    'apps.articles',
]
```


### 2. è¨­è¨ˆmodel
è¨­è¨ˆå®Œæ¨¡å‹å¾Œï¼Œ**è«‹åœ¨å®¹å™¨å…§åŸ·è¡Œä»¥ä¸‹å‘½ä»¤**

1. å»ºç«‹é·ç§»è…³æœ¬ï¼Œå¯åœ¨migrationsçœ‹è¦‹é·ç§»è…³æœ¬ï¼Œè«‹æ ¹æ“šéœ€æ±‚èª¿æ•´
    ```
    python manage.py makemigrations <app-name>
    ```
2. ç¢ºèªå®Œé·ç§»è…³æœ¬æ²’å•é¡Œå¾Œï¼Œé·ç§»è…³æœ¬å…§å®¹
    ```
    python manage.py migrate
    ```

### 3. æ±ºå®šä½¿ç”¨å“ªä¸€ç¨®View Base
#### å®šç¾©ViewBaseçš„ä½¿ç”¨æƒ…å¢ƒ

**ğŸ“Œ é¸æ“‡ä½¿ç”¨çš„æ™‚æ©Ÿ**

| **é¡åˆ¥** | **é©ç”¨å ´æ™¯** | **æä¾›çš„è¡Œç‚º** | **æ˜¯å¦å¯ä¿®æ”¹** |
|---------|------------|--------------|-------|
| **ViewSet** | å®Œå…¨è‡ªè¨‚ APIï¼Œè¡Œç‚ºä¸ä¸€å®šæ˜¯æ¨™æº– CRUD | éœ€æ‰‹å‹•å°æ‡‰ HTTP æ–¹æ³• |  å®Œå…¨å®¢è£½ |
| **GenericViewSet** | éœ€è¦éƒ¨åˆ†æ¨™æº– CRUDï¼Œä½†ä»éœ€æ“´å±• | éœ€è¦æ­é… `mixins.*` ä¾†æä¾› CRUD è¡Œç‚º |  |
| **ReadOnlyModelViewSet** | åƒ…æä¾› **æŸ¥è©¢** (`list`ã€`retrieve`) | å…§å»º `list()` & `retrieve()` |  åªæœ‰è®€å– |
| **ModelViewSet** | å®Œæ•´ **CRUD API** | å…§å»º `list()`ã€`retrieve()`ã€`create()`ã€`update()`ã€`partial_update()`ã€`destroy()` | å®Œæ•´ CRUD |


**ğŸ“Œ `@action`çš„ä½¿ç”¨**
æ‰€æœ‰çš„view baseéƒ½å¯ä»¥æ­é…ä½¿ç”¨`@action`ä¾†æ“´å……åŠŸèƒ½ï¼Œä»¥ä¸‹æä¾›å…·é«”ç¯„ä¾‹

- **ViewSet** - å®Œå…¨å®¢è£½ API
   ç•¶ API éœ€è¦é¡å¤–çš„è‡ªè¨‚è¡Œç‚ºï¼Œä¾‹å¦‚ `/custom/{id}/extra-action/`
    ```python
    # views.py
    from rest_framework.viewsets import ViewSet
    from rest_framework.response import Response
    from rest_framework.decorators import action
    
    
    class CustomViewSet(ViewSet):
        @action(detail=True, methods=["get"])
        def extra_action(self, request, pk=None):
            return Response({"message": f"Custom action for {pk}"})
    
        @action(detail=False, methods=["get"])
        def summary(self, request):
            return Response({"message": "Summary of all items"})
    ```

    ```python
    # urls.py
    from django.urls import include, path
    from rest_framework.routers import SimpleRouter
    from .views import CustomViewSet
    router = SimpleRouter(False)
    router.register(r'', CustomViewSet)
    
    urlpatterns = [
        path("", include(router.urls)),
    ]
    ```
    âœ… ä½¿ç”¨ `SimpleRouter`ï¼Œé¿å…æ‰‹å‹•è¨»å†Š URL

    âœ… `@action` ç›´æ¥å°æ‡‰ `/custom/{id}/extra_action/` å’Œ `/custom/summary/`

- **GenericViewSet** - éƒ¨åˆ†æ¨™æº– CRUD
   API éœ€è¦ `list()` + é¡å¤–çš„æŸ¥è©¢ APIï¼Œä¾‹å¦‚ `/example-generic/stats/`
 
    ```python
    # views.py
    
    from rest_framework.viewsets import GenericViewSet
    from rest_framework import mixins
    from rest_framework.response import Response
    from rest_framework.decorators import action
    from .models import ExampleModel
    from .serializers import ExampleSerializer
    
    class ExampleGenericViewSet(mixins.ListModelMixin, mixins.CreateModelMixin, GenericViewSet):
        queryset = ExampleModel.objects.all()
        serializer_class = ExampleSerializer
    
        @action(detail=False, methods=["get"])
        def stats(self, request):
            return Response({"total": self.queryset.count()})
    
    ```

    ```python
    # urls.py
    from django.urls import include, path
    from rest_framework.routers import SimpleRouter
    from .views import ExampleGenericViewSet
    router = SimpleRouter(False)
    router.register(r'', ExampleGenericViewSet)
    
    urlpatterns = [
        path("", include(router.urls)),
        ]
    ```

   âœ… é©åˆæ¨™æº– CRUD ä½†éœ€é¡å¤– APIï¼Œå¦‚çµ±è¨ˆã€éæ¿¾ç­‰ï¼Œå°æ‡‰çš„APIè«‹ä½¿ç”¨`mixins.*`
   
   âœ… `@action(detail=False)` å¯æ–°å¢ `/example-generic/stats/`

- **ReadOnlyModelViewSet** - åªæä¾›æŸ¥è©¢ API

   API åªæä¾› è®€å–ï¼Œä½†éœ€è¦é¡å¤–çš„å ±å‘Šæˆ–çµ±è¨ˆï¼Œå¦‚ `/example-readonly/report/`

    ```python
    # views.py
    from rest_framework.viewsets import ReadOnlyModelViewSet
    from rest_framework.response import Response
    from rest_framework.decorators import action
    from .models import ExampleModel
    from .serializers import ExampleSerializer
    
    class ExampleReadOnlyViewSet(ReadOnlyModelViewSet):
        queryset = ExampleModel.objects.all()
        serializer_class = ExampleSerializer
    
        @action(detail=False, methods=["get"])
        def report(self, request):
            return Response({"report": "Sample report data"})
    ```

    ```python
    # urls.py
    from django.urls import include, path
    from rest_framework.routers import SimpleRouter
    from .views import ExampleReadOnlyViewSet
    
    router = SimpleRouter(False)
    router.register(r'', ExampleReadOnlyViewSet)
    
    urlpatterns = [
        path("", include(router.urls)),
    ]
    ```

   âœ… é©åˆåªè®€å–è³‡æ–™çš„ APIï¼Œä¸¦é¡å¤–æä¾›çµ±è¨ˆ API
   
   âœ… `@action(detail=False)` è®“ `/example-readonly/report/` æä¾›çµ±è¨ˆè³‡è¨Š

- **ModelViewSet** - å®Œæ•´ CRUD
   API éœ€è¦å®Œæ•´ CRUDï¼Œä¸¦é¡å¤–æä¾› ç‹€æ…‹è®Šæ›´ API `/example-model/{id}/publish/`

    ```python
    # views.py
    from rest_framework.viewsets import ModelViewSet
    from rest_framework.response import Response
    from rest_framework.decorators import action
    
    from .models import ExampleModel
    from .serializers import ExampleSerializer
    
    class ExampleModelViewSet(ModelViewSet):
        queryset = ExampleModel.objects.all()
        serializer_class = ExampleSerializer
    
        @action(detail=True, methods=["post"])
        def publish(self, request, pk=None):
            instance = self.get_object()
            instance.is_published = True
            instance.save()
            return Response({"message": f"Item {pk} published"})
    ```

    ```python
    # urls.py
    from django.urls import include, path
    from rest_framework.routers import SimpleRouter
    from .views import ExampleReadOnlyViewSet
    
    router = SimpleRouter(False)
    router.register(r'', ExampleReadOnlyViewSet)
    
    urlpatterns = [
        path("", include(router.urls)),
    ]
    ```

   è‡ªå‹•ç”¢ç”Ÿæ¨™æº– CRUD
   ```
   GET /example-model/       # åˆ—å‡ºæ‰€æœ‰è³‡æ–™
   POST /example-model/      # æ–°å¢
   GET /example-model/{id}/  # å–å¾—å–®ç­†
   PUT /example-model/{id}/  # æ›´æ–°
   PATCH /example-model/{id}/  # éƒ¨åˆ†æ›´æ–°
   DELETE /example-model/{id}/  # åˆªé™¤
   ```
   
   é¡å¤–æ–°å¢ `/example-model/{id}/publish/`
   ```
   POST /example-model/{id}/publish/  # è®Šæ›´ç‹€æ…‹
   ```
   âœ… é©åˆæ¨™æº– CRUDï¼Œä½†éœ€è¦é¡å¤– API ä¾†è®Šæ›´ç‹€æ…‹
   
   âœ… ä½¿ç”¨ `@action(detail=True)` ä¾†æ”¯æ´ `/publish/` é€™é¡ API

**ğŸ“Œ çµè«–**

| **é¡åˆ¥** | **é©ç”¨å ´æ™¯** | **è¡Œç‚º** | **é©åˆç”¨ `@action` çš„æƒ…å¢ƒ** |
|---------|------------|------------|---------------------------|
| **ViewSet** | **å®Œå…¨å®¢è£½ API**ï¼Œè¡Œç‚ºä¸ä¸€å®šæ˜¯ CRUD | éœ€è¦æ‰‹å‹•å°æ‡‰ HTTP æ–¹æ³• | éœ€è¦æ–°å¢é CRUD æ“ä½œï¼Œå¦‚ `/custom/{id}/extra-action/` |
| **GenericViewSet** | éœ€è¦éƒ¨åˆ†æ¨™æº– CRUDï¼Œä»éœ€æ“´å±• | éœ€æ­é… `mixins.*` | æƒ³åœ¨ `list()` ä¹‹å¤–å¢åŠ é¡å¤–æŸ¥è©¢ï¼Œå¦‚ `/example-generic/stats/` |
| **ReadOnlyModelViewSet** | åªæä¾›æŸ¥è©¢ API (`list()` & `retrieve()`) | å…§å»º `list()` & `retrieve()` | æƒ³æä¾›é¡å¤–çµ±è¨ˆï¼Œå¦‚ `/example-readonly/report/` |
| **ModelViewSet** | **å®Œæ•´ CRUD** API | å…§å»ºæ¨™æº– CRUD è¡Œç‚º | æƒ³æä¾›é¡å¤–çš„ç‹€æ…‹è®Šæ›´ APIï¼Œå¦‚ `/example-model/{id}/publish/` |

### 4. è¨­è¨ˆserializer
#### serializerçš„åŠŸèƒ½
- åºåˆ—åŒ–èˆ‡ååºåˆ—åŒ–: è™•ç† API çš„è¼¸å…¥èˆ‡è¼¸å‡ºè³‡æ–™æ ¼å¼ï¼Œé€é serializers é€²è¡Œé©—è­‰èˆ‡æ ¼å¼è½‰æ›ã€‚
- è³‡æ–™é©—è­‰: æ‡‰å°ˆæ³¨æ–¼ã€Œç´”é©—è­‰ã€ï¼Œç„¡å¤–éƒ¨ä¾è³´çš„å±¬æ€§é©—è­‰èˆ‡è·¨æ¬„ä½æª¢æŸ¥ï¼Œå¯å°‡æ¶‰åŠå¤–éƒ¨ä¾è³´ã€æ¥­å‹™è¦å‰‡æˆ–è¨ˆç®—çš„é©—è­‰é‚è¼¯çš„ç¨‹å¼æ”¾åœ¨ `services.py`
```python
class UserRegisterSerializer(serializers.ModelSerializer):
    phone = serializers.CharField(validators=[phone_regex])
    confirm_password = serializers.CharField(write_only=True)

    class Meta:
        model = User
        fields = ['full_name', 'nickname', 'phone', 'email', 'password', 'confirm_password']
        extra_kwargs = {
            'password': {'write_only': True}
        }

    def validate(self, data):
        if data['password'] != data['confirm_password']:
            raise serializers.ValidationError({"confirm_password": "å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ä¸€è‡´"})
        return data

    def create(self, validated_data):
        validated_data.pop('confirm_password')
        return User.objects.create_user(**validated_data)
```

### 5. è¨»å†ŠAPI
**è¨˜å¾—åœ¨`core/urls.py`ï¼Œé…ç½®ä½ çš„app**
```python
api_urlpatterns = [
    # Swagger API æ–‡æª”
    path("schema/", SpectacularAPIView.as_view(), name="schema"),
    path("docs/", SpectacularSwaggerView.as_view(url_name="schema"), name="docs"),
    path("redoc/", SpectacularRedocView.as_view(url_name="schema"), name="redoc"),
    # Apps
    path("users/", include("apps.users.urls")),
    path("auth/", include("apps.auth.urls")),
    path("orders/", include("apps.orders.urls")),
    path("articles/", include("apps.articles.urls")),  # <----- æ–°å¢ä½ çš„app  
]

urlpatterns = [
    path("", RedirectView.as_view(url=reverse_lazy("docs"))),
    path("admin/", admin.site.urls),
    path("api/v1/", include(api_urlpatterns)),  # è¨»å†Šç•¶å‰ API
]
```
**`core/settings.py`ä¸­ï¼Œåœ¨`LOCAL_APP`è¨»å†Šä½ çš„app**
```python
LOCAL_APPS = [
    'apps.users',
    'apps.orders',
    'apps.articles', # <----- æ–°å¢ä½ çš„app  
]
```


**ğŸ“Œ çµè«–**

| **ViewSet é¡å‹** | **æ˜¯å¦å…§å»º CRUD** | **é©åˆå ´æ™¯** |
|---------------|---------------|------------|
| **ViewSet** | âŒï¼ˆéœ€æ‰‹å‹•å®šç¾©ï¼‰ | å®Œå…¨å®¢è£½åŒ– API |
| **GenericViewSet** | âŒï¼ˆéœ€æ­é… `mixins`ï¼‰ | åªéœ€è¦éƒ¨åˆ† CRUDï¼Œå¦‚ `list` + `create` |
| **ReadOnlyModelViewSet** | âœ… (`list` + `retrieve`) | åªè®€å–è³‡æ–™ï¼Œå¦‚å…¬é–‹è³‡è¨Š API | 
| **ModelViewSet** | âœ… (å®Œæ•´ CRUD) | æ¨™æº– CRUD æ“ä½œ |

### 6. swaggeræ–‡ä»¶å±•ç¤º
è¨ªå• http://127.0.0.1:8010/api/v1/docs/
æŸ¥çœ‹ä½ çš„æœå‹™


